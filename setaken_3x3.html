<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>かぞえるパズル</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Zen Maru Gothic', sans-serif;
    }
    
    .cell-tap {
      animation: tap-bounce 0.3s ease-out;
    }
    
    @keyframes tap-bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.9); }
    }
    
    .cell-correct {
      animation: correct-pulse 0.6s ease-out;
    }
    
    @keyframes correct-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    .cell-wrong {
      animation: wrong-shake 0.5s ease-out;
    }
    
    @keyframes wrong-shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-10px); }
      40%, 80% { transform: translateX(10px); }
    }

    .score-dot {
      transition: all 0.4s ease-out;


/* 既存のスタイルの後に追加 */
  .cell {
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent; /* タップ時の青い枠を消す */
  }
  
  /* スマホのキーボード表示対策 */
  #app-wrapper {
    min-height: -webkit-fill-available;
  }


    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-wrapper" class="min-h-full w-full flex flex-col items-center justify-start sm:justify-center p-4 sm:p-6 overflow-y-auto" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
   <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
    <h1 id="titleText" class="text-4xl font-bold text-center mb-6" style="color: #059669;">いくつみつかるかな？</h1>
    <div class="mb-6"><label for="inputBox" id="inputLabel" class="block font-bold mb-2 text-lg" style="color: #065f46;">4文字の単語を入力してください</label> <input type="text" id="inputBox" maxlength="4" class="w-full px-4 py-3 rounded-xl text-2xl text-center font-bold focus:outline-none focus:ring-4" style="border: 3px solid #10b981; background-color: #f0fdf4; color: #065f46;" value="せたけん">
    </div>
    <p id="instructionText" class="text-center font-semibold mb-4" style="color: #065f46;">となりあう4マスを選択してください</p>
    <div class="grid grid-cols-3 gap-3 mb-6">
     <div id="cell-0" data-index="0" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-1" data-index="1" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-2" data-index="2" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-3" data-index="3" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-4" data-index="4" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-5" data-index="5" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-6" data-index="6" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-7" data-index="7" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold cursor-pointer transition-all" style="background-color: #d1fae5; color: #047857; border: 4px solid #10b981;"></div>
     <div id="cell-8" data-index="8" class="cell aspect-square rounded-2xl flex items-center justify-center text-4xl font-bold" style="background-color: #f0fdf4; color: #10b981; border: 4px solid #a7f3d0;"></div>
    </div>
    <div class="rounded-2xl p-6" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 3px solid #10b981;">
     <div class="mb-4">
      <p class="text-sm font-bold mb-1" style="color: #065f46;">選択中</p>
      <p id="selectedText" class="text-3xl font-bold" style="color: #047857;">-</p>
     </div>
     <div class="mb-4">
      <p id="scoreLabel" class="font-bold text-lg mb-2" style="color: #065f46;">正解数</p>
      <div id="scoreContainer" class="flex gap-2 flex-wrap justify-center min-h-[40px]"></div>
     </div>
     <div id="messageBox" class="mb-4 text-center font-bold text-xl min-h-[32px]"></div><button id="resetButton" class="w-full py-3 rounded-xl font-bold text-white text-lg transition-all hover:opacity-90" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">リセット</button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      title_text: 'かぞえるパズル',
      input_label: '4文字の単語を入力',
      instruction_text: 'となりあう4マスをタップしてください',
      score_label: '正解数',
      background_color: '#059669',
      surface_color: '#d1fae5',
      text_color: '#065f46',
      primary_action_color: '#047857',
      secondary_action_color: '#10b981'
    };

    let grid = ['', '', '', '', '', '', '', '', ''];
    let moji = ['', '', '', ''];
    let selectedCells = [];
    let answeredPatterns = new Set();
    let totalPatterns = 0;
    let score = 0;

    const inputBox = document.getElementById('inputBox');
    const selectedText = document.getElementById('selectedText');
    const scoreContainer = document.getElementById('scoreContainer');
    const messageBox = document.getElementById('messageBox');
    const resetButton = document.getElementById('resetButton');

    // 隣接マス定義（0-indexedで1-9マスを0-8に変換）
    const adjacentMap = {
      0: [1, 3],
      1: [0, 2, 4],
      2: [1, 5],
      3: [0, 4, 6],
      4: [1, 3, 5, 7],
      5: [2, 4, 8],
      6: [3, 7],
      7: [4, 6, 8],
      8: [5, 7]
    };

    function isAdjacent(index1, index2) {
      return adjacentMap[index1].includes(index2);
    }

    function calculateAllPatterns() {
      const patterns = new Set();
      const target = moji.join('');
      
      function findPaths(path) {
        if (path.length === 4) {
          let word = '';
          for (let i = 0; i < 4; i++) {
            word += grid[path[i]];
          }
          if (word === target) {
            patterns.add(path.join(','));
          }
          return;
        }
        
        if (path.length === 0) {
          for (let i = 0; i < 9; i++) {
            if (grid[i] !== '') {
              findPaths([i]);
            }
          }
        } else {
          const last = path[path.length - 1];
          for (const next of adjacentMap[last]) {
            if (!path.includes(next) && grid[next] !== '') {
              findPaths([...path, next]);
            }
          }
        }
      }
      
      findPaths([]);
      return patterns.size;
    }

// updateGrid関数内を以下に更新
function updateGrid() {
  const input = inputBox.value;
  moji = ['', '', '', ''];
  
  for (let i = 0; i < Math.min(4, input.length); i++) {
    moji[i] = input[i];
  }

  // ご指定の新しい配置（grid[8]にmoji[0]を追加）
  grid[0] = moji[0];
  grid[1] = moji[1];
  grid[2] = moji[2];
  grid[3] = moji[1];
  grid[4] = moji[2];
  grid[5] = moji[3];
  grid[6] = moji[2];
  grid[7] = moji[3];
  grid[8] = moji[0]; // ここを空文字から変更

  // マス目に表示
  for (let i = 0; i < 9; i++) {
    const cell = document.getElementById(`cell-${i}`);
    cell.textContent = grid[i];
    
    // grid[8]も他のマスと同じデザイン（背景色など）にするための調整
    if (i === 8) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      cell.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
      cell.style.color = config.primary_action_color || defaultConfig.primary_action_color;
      cell.style.borderColor = config.secondary_action_color || defaultConfig.secondary_action_color;
      cell.classList.add('cursor-pointer'); // クリック可能であることを示す
    }
  }

  // 正解パターン数を再計算
  if (input.length === 4) {
    totalPatterns = calculateAllPatterns();
    renderScoreDots();
  } else {
    totalPatterns = 0;
    scoreContainer.innerHTML = '';
  }

  resetGame();
}

    function renderScoreDots() {
      scoreContainer.innerHTML = '';
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      
      for (let i = 0; i < totalPatterns; i++) {
        const dot = document.createElement('span');
        dot.className = 'score-dot text-4xl';
        dot.textContent = '●';
        dot.style.color = surfaceColor;
        dot.id = `dot-${i}`;
        scoreContainer.appendChild(dot);
      }
    }

    function resetGame() {
      selectedCells = [];
      answeredPatterns.clear();
      score = 0;
      selectedText.textContent = '-';
      messageBox.textContent = '';
      messageBox.style.color = '';
      
      document.querySelectorAll('.cell').forEach(cell => {
        cell.style.opacity = '1';
        cell.classList.remove('cell-tap', 'cell-correct', 'cell-wrong');
      });

      if (totalPatterns > 0) {
        renderScoreDots();
      }
    }

    function handleCellClick(event) {
      if (moji.join('').length !== 4) return;

      const cellIndex = parseInt(event.currentTarget.dataset.index);
      
      if (grid[cellIndex] === '') return;
      if (selectedCells.includes(cellIndex)) return;

      // 隣接チェック
      if (selectedCells.length > 0) {
        const lastCell = selectedCells[selectedCells.length - 1];
        if (!isAdjacent(lastCell, cellIndex)) {
          return;
        }
      }

      selectedCells.push(cellIndex);
      
      const cell = event.currentTarget;
      cell.classList.add('cell-tap');
      cell.style.opacity = '0.6';

      // 選択中の文字を表示
      let selected = '';
      for (let i = 0; i < selectedCells.length; i++) {
        selected += grid[selectedCells[i]];
      }
      selectedText.textContent = selected;

      // 4マス選択されたら判定
      if (selectedCells.length === 4) {
        setTimeout(() => {
          checkAnswer();
        }, 300);
      }
    }

    function checkAnswer() {
      let selectedWord = '';
      for (let i = 0; i < 4; i++) {
        selectedWord += grid[selectedCells[i]];
      }

      const targetWord = moji.join('');
      const patternKey = selectedCells.join(',');

      if (selectedWord === targetWord) {
        if (answeredPatterns.has(patternKey)) {
          // 回答済み
          selectedCells.forEach(index => {
            document.getElementById(`cell-${index}`).classList.add('cell-wrong');
          });
          
          messageBox.textContent = '回答済です';
          messageBox.style.color = '#dc2626';
          
          setTimeout(() => {
            clearSelection();
            messageBox.textContent = '';
          }, 1500);
        } else {
          // 正解
          answeredPatterns.add(patternKey);
          
          selectedCells.forEach(index => {
            document.getElementById(`cell-${index}`).classList.add('cell-correct');
          });

          // スコアドットの色を変更
          const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
          const primaryColor = config.background_color || defaultConfig.background_color;
          
          if (score < totalPatterns) {
            const dot = document.getElementById(`dot-${score}`);
            if (dot) {
              dot.style.color = primaryColor;
              dot.style.transform = 'scale(1.3)';
              setTimeout(() => {
                dot.style.transform = 'scale(1)';
              }, 400);
            }
          }

          score++;

          if (score === totalPatterns) {
            messageBox.textContent = '全問正解です！';
            messageBox.style.color = '#16a34a';
            
            setTimeout(() => {
              clearSelection();
            }, 2500);
          } else {
            setTimeout(() => {
              clearSelection();
            }, 1000);
          }
        }
      } else {
        // 不正解
        selectedCells.forEach(index => {
          document.getElementById(`cell-${index}`).classList.add('cell-wrong');
        });
        
        setTimeout(() => {
          clearSelection();
        }, 800);
      }
    }

    function clearSelection() {
      selectedCells = [];
      selectedText.textContent = '-';
      
      document.querySelectorAll('.cell').forEach(cell => {
        cell.style.opacity = '1';
        cell.classList.remove('cell-tap', 'cell-correct', 'cell-wrong');
      });

      if (score !== totalPatterns) {
        messageBox.textContent = '';
      }
    }

    // イベントリスナー
    inputBox.addEventListener('input', updateGrid);
    resetButton.addEventListener('click', resetGame);

    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', handleCellClick);
    });

    // 初期表示
    updateGrid();

    // Element SDK
    async function onConfigChange(config) {
      document.getElementById('titleText').textContent = config.title_text || defaultConfig.title_text;
      document.getElementById('inputLabel').textContent = config.input_label || defaultConfig.input_label;
      document.getElementById('instructionText').textContent = config.instruction_text || defaultConfig.instruction_text;
      document.getElementById('scoreLabel').textContent = config.score_label || defaultConfig.score_label;

      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;

      document.getElementById('titleText').style.color = bgColor;
      document.getElementById('app-wrapper').style.background = `linear-gradient(135deg, ${bgColor} 0%, ${primaryColor} 100%)`;
      
      document.getElementById('inputLabel').style.color = textColor;
      document.getElementById('instructionText').style.color = textColor;
      document.getElementById('scoreLabel').style.color = textColor;
      document.querySelector('#messageBox').style.color = textColor;

      const input = document.getElementById('inputBox');
      input.style.borderColor = secondaryColor;
      input.style.backgroundColor = '#f0fdf4';
      input.style.color = textColor;

      resetButton.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${primaryColor} 100%)`;

      for (let i = 0; i < 8; i++) {
        const cell = document.getElementById(`cell-${i}`);
        cell.style.backgroundColor = surfaceColor;
        cell.style.color = primaryColor;
        cell.style.borderColor = secondaryColor;
      }

      const emptyCell = document.getElementById('cell-8');
      emptyCell.style.backgroundColor = '#f0fdf4';
      emptyCell.style.color = secondaryColor;
      emptyCell.style.borderColor = '#a7f3d0';

      // スコアドットの更新
      const dots = scoreContainer.querySelectorAll('.score-dot');
      dots.forEach((dot, index) => {
        if (index < score) {
          dot.style.color = bgColor;
        } else {
          dot.style.color = surfaceColor;
        }
      });
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            },
            {
              get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (value) => {
                config.secondary_action_color = value;
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['title_text', config.title_text || defaultConfig.title_text],
          ['input_label', config.input_label || defaultConfig.input_label],
          ['instruction_text', config.instruction_text || defaultConfig.instruction_text],
          ['score_label', config.score_label || defaultConfig.score_label]
        ])
      });
    }
  </script>
 </body>
</html>